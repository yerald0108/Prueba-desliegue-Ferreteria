{% extends 'shop/base.html' %}

{% block title %}Iniciar Sesión - Ferretería{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow-lg">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <i class="bi bi-box-arrow-in-right text-primary" style="font-size: 4rem;"></i>
                        <h2 class="mt-3">Iniciar Sesión</h2>
                        <p class="text-muted">Accede a tu cuenta</p>
                    </div>
                    
                    <form method="post" id="loginForm">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="email" class="form-label">
                                <i class="bi bi-envelope"></i> Correo electrónico
                            </label>
                            <input type="email" 
                                   class="form-control form-control-lg" 
                                   id="email" 
                                   name="email" 
                                   placeholder="tu-correo@gmail.com"
                                   required
                                   autofocus>
                        </div>
                        
                        <div class="mb-4">
                            <label for="password" class="form-label">
                                <i class="bi bi-lock"></i> Contraseña
                            </label>
                            <div class="input-group">
                                <input type="password" 
                                       class="form-control form-control-lg" 
                                       id="password" 
                                       name="password" 
                                       placeholder="Tu contraseña"
                                       required>
                                <button type="button" class="btn btn-outline-secondary" id="toggleLoginPassword" data-target="password">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="remember">
                            <label class="form-check-label" for="remember">
                                Recordarme
                            </label>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-lg w-100" id="loginBtn">
                            <i class="bi bi-box-arrow-in-right"></i> Iniciar Sesión
                        </button>
                    </form>
                    
                    <div id="loginError" class="alert alert-danger mt-3" style="display: none;"></div>
                    
                    <hr class="my-4">
                    
                    <div class="text-center">
                        <p class="text-muted mb-3">¿No tienes cuenta?</p>
                        <a href="{% url 'shop:register' %}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-person-plus"></i> Crear Cuenta Nueva
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $('#toggleLoginPassword').on('click', function() {
        var targetId = $(this).data('target');
        var $input = $('#' + targetId);
        var $icon = $(this).find('i');
        if ($input.attr('type') === 'password') {
            $input.attr('type', 'text');
        } else {
            $input.attr('type', 'password');
        }
        $icon.toggleClass('bi-eye bi-eye-slash');
    });
    $('#loginForm').on('submit', function(e) {
        e.preventDefault();
        
        var $form = $(this);
        var $btn = $('#loginBtn');
        var $error = $('#loginError');
        var originalText = $btn.html();
        
        // Ocultar errores previos
        $error.hide();
        
        // Deshabilitar botón y mostrar loading
        $btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Iniciando sesión...');
        
        $.ajax({
            url: '{% url "shop:login" %}',
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            data: $form.serialize(),
            success: function(response) {
                if (response && response.success) {
                    // Guardar mensaje en sessionStorage para mostrar después de la redirección
                    sessionStorage.setItem('successNotification', 'Sesión iniciada exitosamente');
                    
                    // Redirigir inmediatamente
                    var nextUrl = new URLSearchParams(window.location.search).get('next');
                    if (nextUrl) {
                        window.location.href = nextUrl;
                    } else {
                        window.location.href = '{% url "shop:home" %}';
                    }
                }
            },
            error: function(xhr) {
                // Restaurar botón
                $btn.prop('disabled', false).html(originalText);
                
                // Mostrar error
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    $error.text(xhr.responseJSON.error).show();
                } else {
                    // Si la respuesta es HTML (redirección de Django), extraer el mensaje de error
                    var $response = $(xhr.responseText);
                    var errorMsg = $response.find('.alert-danger').text() || 'Usuario o contraseña incorrectos';
                    $error.text(errorMsg.trim()).show();
                }
            }
        });
    });
});
</script>
{% endblock %}
