{% extends 'shop/base.html' %}
{% load static %}

{% block title %}Cambiar Contraseña - Ferretería{% endblock %}

{% block extra_css %}
<!-- Estilos de change_password.html -->
<link rel="stylesheet" href="{% static 'css/change_password.css' %}">
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="text-center mb-4">
                <i class="bi bi-shield-lock text-primary" style="font-size: 4rem;"></i>
                <h2 class="mt-3">Cambiar Contraseña</h2>
                <p class="text-muted">Actualiza tu contraseña para mantener tu cuenta segura</p>
            </div>
            
            <div class="row">
                <!-- Formulario -->
                <div class="col-lg-7">
                    <div class="card shadow-sm mb-4">
                        <div class="card-body p-4">
                            <form method="post" id="changePasswordForm" novalidate>
                                {% csrf_token %}
                                
                                <!-- Contraseña Actual -->
                                <div class="mb-4">
                                    <label for="{{ form.current_password.id_for_label }}" class="form-label fw-bold">
                                        <i class="bi bi-lock"></i> {{ form.current_password.label }}
                                    </label>
                                    <div class="input-group">
                                        {{ form.current_password }}
                                        <button type="button" class="btn btn-outline-secondary toggle-password" 
                                                data-target="{{ form.current_password.id_for_label }}">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    {% if form.current_password.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ form.current_password.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle"></i> {{ form.current_password.help_text }}
                                    </small>
                                </div>
                                
                                <hr class="my-4">
                                
                                <!-- Nueva Contraseña -->
                                <div class="mb-3">
                                    <label for="{{ form.new_password1.id_for_label }}" class="form-label fw-bold">
                                        <i class="bi bi-key"></i> {{ form.new_password1.label }}
                                    </label>
                                    <div class="input-group">
                                        {{ form.new_password1 }}
                                        <button type="button" class="btn btn-outline-secondary toggle-password" 
                                                data-target="{{ form.new_password1.id_for_label }}">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Medidor de Fortaleza -->
                                    <div class="password-strength-meter">
                                        <div class="password-strength-bar" id="strengthBar"></div>
                                    </div>
                                    <small id="strengthText" class="text-muted"></small>
                                    
                                    {% if form.new_password1.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ form.new_password1.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Confirmar Nueva Contraseña -->
                                <div class="mb-4">
                                    <label for="{{ form.new_password2.id_for_label }}" class="form-label fw-bold">
                                        <i class="bi bi-check-circle"></i> {{ form.new_password2.label }}
                                    </label>
                                    <div class="input-group">
                                        {{ form.new_password2 }}
                                        <button type="button" class="btn btn-outline-secondary toggle-password" 
                                                data-target="{{ form.new_password2.id_for_label }}">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    {% if form.new_password2.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ form.new_password2.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Requisitos de Contraseña -->
                                <div class="password-requirements">
                                    <h6 class="mb-3">
                                        <i class="bi bi-clipboard-check"></i> Requisitos de Contraseña:
                                    </h6>
                                    <div class="requirement-item" id="req-length">
                                        <i class="bi bi-circle"></i>
                                        <span>Al menos 8 caracteres</span>
                                    </div>
                                    <div class="requirement-item" id="req-uppercase">
                                        <i class="bi bi-circle"></i>
                                        <span>Al menos una letra mayúscula</span>
                                    </div>
                                    <div class="requirement-item" id="req-lowercase">
                                        <i class="bi bi-circle"></i>
                                        <span>Al menos una letra minúscula</span>
                                    </div>
                                    <div class="requirement-item" id="req-number">
                                        <i class="bi bi-circle"></i>
                                        <span>Al menos un número</span>
                                    </div>
                                    <div class="requirement-item" id="req-special">
                                        <i class="bi bi-circle"></i>
                                        <span>Al menos un carácter especial (@, #, $, etc.)</span>
                                    </div>
                                </div>
                                
                                <!-- Botones -->
                                <div class="d-grid gap-2 mt-4">
                                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                        <i class="bi bi-shield-check"></i> Cambiar Contraseña
                                    </button>
                                    <a href="{% url 'shop:profile' %}" class="btn btn-outline-secondary">
                                        <i class="bi bi-x-circle"></i> Cancelar
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Tips de Seguridad -->
                <div class="col-lg-5">
                    <div class="security-tips mb-4">
                        <h5>
                            <i class="bi bi-shield-fill-check"></i> Consejos de Seguridad
                        </h5>
                        <ul>
                            <li>
                                <strong>Usa contraseñas únicas</strong><br>
                                No reutilices contraseñas en diferentes sitios
                            </li>
                            <li>
                                <strong>Combina caracteres</strong><br>
                                Mezcla letras, números y símbolos
                            </li>
                            <li>
                                <strong>Evita información personal</strong><br>
                                No uses tu nombre, fecha de nacimiento o datos obvios
                            </li>
                            <li>
                                <strong>Usa un gestor de contraseñas</strong><br>
                                Herramientas como LastPass, 1Password o Bitwarden
                            </li>
                            <li>
                                <strong>Cambia periódicamente</strong><br>
                                Actualiza tu contraseña cada 3-6 meses
                            </li>
                        </ul>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill"></i>
                        <strong>Notificación de Cambio</strong>
                        <p class="mb-0 small">
                            Te enviaremos un email de confirmación cuando cambies tu contraseña exitosamente.
                        </p>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>¿Problemas para acceder?</strong>
                        <p class="mb-0 small">
                            Si olvidaste tu contraseña, puedes recuperarla desde la página de inicio de sesión.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Toggle mostrar/ocultar contraseña
        $('.toggle-password').on('click', function() {
            const targetId = $(this).data('target');
            const $input = $('#' + targetId);
            const $icon = $(this).find('i');
        
            if ($input.attr('type') === 'password') {
                $input.attr('type', 'text');
                $icon.removeClass('bi-eye').addClass('bi-eye-slash');
            } else {
                $input.attr('type', 'password');
                $icon.removeClass('bi-eye-slash').addClass('bi-eye');
            }
        });
    
        // Validación en tiempo real de la nueva contraseña
        $('#{{ form.new_password1.id_for_label }}').on('input', function() {
            const password = $(this).val();
        
            // Verificar requisitos
            const hasLength = password.length >= 8;
            const hasUppercase = /[A-Z]/.test(password);
            const hasLowercase = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
        
            // Actualizar indicadores visuales
            updateRequirement('req-length', hasLength);
            updateRequirement('req-uppercase', hasUppercase);
            updateRequirement('req-lowercase', hasLowercase);
            updateRequirement('req-number', hasNumber);
            updateRequirement('req-special', hasSpecial);
        
            // Calcular fortaleza
            let strength = 0;
            if (hasLength) strength++;
            if (hasUppercase) strength++;
            if (hasLowercase) strength++;
            if (hasNumber) strength++;
            if (hasSpecial) strength++;
        
            // Actualizar medidor de fortaleza
            updateStrengthMeter(strength);
        });
    
        function updateRequirement(id, met) {
            const $req = $('#' + id);
            if (met) {
                $req.addClass('met');
                $req.find('i').removeClass('bi-circle').addClass('bi-check-circle-fill');
            } else {
                $req.removeClass('met');
                $req.find('i').removeClass('bi-check-circle-fill').addClass('bi-circle');
            }
        }
    
        function updateStrengthMeter(strength) {
            const $bar = $('#strengthBar');
            const $text = $('#strengthText');
        
            $bar.removeClass('strength-weak strength-medium strength-strong');
        
            if (strength <= 2) {
                $bar.addClass('strength-weak');
                $text.text('Débil').css('color', '#dc3545');
            } else if (strength <= 4) {
                $bar.addClass('strength-medium');
                $text.text('Media').css('color', '#ffc107');
            } else {
                $bar.addClass('strength-strong');
                $text.text('Fuerte').css('color', '#28a745');
            }
        }
    
        // Validación antes de enviar
        $('#changePasswordForm').on('submit', function(e) {
            const password1 = $('#{{ form.new_password1.id_for_label }}').val();
            const password2 = $('#{{ form.new_password2.id_for_label }}').val();
        
            if (password1 !== password2) {
                e.preventDefault();
                //  TOAST DE ERROR 
                Toast.error('Error', 'Las contraseñas no coinciden. Por favor verifica.', {
                    duration: 4000
                });
                return false;
            }
        
            // Mostrar loading
            const $btn = $('#submitBtn');
            const originalText = $btn.html();
            $btn.prop('disabled', true)
                .html('<i class="bi bi-hourglass-split"></i> Cambiando contraseña...');

            //  TOAST DE LOADING 
            Toast.info('Procesando', 'Cambiando tu contraseña...', {
                duration: 2000,
                closeButton: false
            });
    
            // Guardar mensaje para después de la recarga
            sessionStorage.setItem('successNotification', 'Contraseña cambiada exitosamente');
        });
    });
</script>
{% endblock %}