{% extends 'shop/base.html' %}

{% block title %}Productos - Ferretería{% endblock %}

{% block extra_css %}
<style>
    /* Animación de carga */
    .products-loading {
        position: relative;
        pointer-events: none;
        opacity: 0.6;
        transition: opacity 0.3s;
    }
    
    .loading-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 100;
    }
    
    .spinner-border-custom {
        width: 3rem;
        height: 3rem;
        border-width: 0.3em;
    }
    
    /* Animación de entrada de productos */
    .product-card-wrapper {
        animation: fadeInUp 0.5s ease-out;
        animation-fill-mode: both;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Delay escalonado para cards */
    .product-card-wrapper:nth-child(1) { animation-delay: 0.05s; }
    .product-card-wrapper:nth-child(2) { animation-delay: 0.1s; }
    .product-card-wrapper:nth-child(3) { animation-delay: 0.15s; }
    .product-card-wrapper:nth-child(4) { animation-delay: 0.2s; }
    .product-card-wrapper:nth-child(5) { animation-delay: 0.25s; }
    .product-card-wrapper:nth-child(6) { animation-delay: 0.3s; }
    
    /* Paginación mejorada */
    .pagination-wrapper {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .page-link {
        border-radius: 10px !important;
        margin: 0 3px;
        border: none;
        color: var(--secondary-color);
        font-weight: 600;
    }
    
    .page-link:hover {
        background-color: var(--primary-color);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 107, 53, 0.3);
    }
    
    .page-item.active .page-link {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
    }
    
    .page-item.disabled .page-link {
        background-color: #f5f5f5;
        border-color: #dee2e6;
    }
    
    /* Smooth scroll */
    html {
        scroll-behavior: smooth;
    }
    
    /* Controles de vista */
    .view-controls {
        background: white;
        padding: 1rem;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
    }
    
    .btn-group-sm .btn {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }
    
    /* Información de resultados */
    .results-info {
        color: #666;
        font-size: 0.9rem;
    }
    
    /* Sidebar de filtros inteligente */
    .filters-sidebar {
        position: relative;
    }
    
    .filters-sidebar .card {
        position: sticky;
        top: 90px; /* Valor inicial, se ajustará dinámicamente */
        max-height: calc(100vh - 100px);
        overflow-y: auto;
        transition: top 0.2s ease-out;
        z-index: 100; /* Por debajo del navbar (z-index 1020 de Bootstrap) */
    }
    
    /* Cuando el sidebar llega al final, ajustar posición */
    .filters-sidebar .card.sticky-bottom {
        position: absolute;
        bottom: 0;
        top: auto;
    }
    
    /* Scrollbar personalizado para el sidebar */
    .filters-sidebar .card::-webkit-scrollbar {
        width: 6px;
    }
    
    .filters-sidebar .card::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .filters-sidebar .card::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 10px;
    }
    
    .filters-sidebar .card::-webkit-scrollbar-thumb:hover {
        background: #e55a2b;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5" id="products-section">
    <div class="row">
        <!-- Sidebar Filtros -->
        <div class="col-lg-3 mb-4 filters-sidebar">
            <div class="card shadow-sm" id="filtersCard">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="bi bi-funnel"></i> Filtros
                    </h5>
                    
                    <!-- Búsqueda -->
                    <div class="mb-4">
                        <form method="get" action="{% url 'shop:product_list' %}" id="searchForm">
                            <div class="input-group">
                                <input type="text" 
                                       class="form-control" 
                                       id="searchInput"
                                       name="q" 
                                       placeholder="Buscar..." 
                                       value="{{ query|default:'' }}"
                                       autocomplete="off">
                                <button class="btn btn-primary" type="submit">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Categorías -->
                    <h6 class="mb-3">Categorías</h6>
                    <div class="list-group mb-4">
                        <a href="{% url 'shop:product_list' %}" 
                           class="list-group-item list-group-item-action {% if not current_category %}active{% endif %}">
                            <i class="bi bi-grid"></i> Todas
                        </a>
                        {% for category in categories %}
                            <a href="?category={{ category.slug }}" 
                               class="list-group-item list-group-item-action category-filter {% if current_category == category.slug %}active{% endif %}"
                               data-category="{{ category.slug }}">
                                <i class="bi bi-tag"></i> {{ category.name }}
                            </a>
                        {% endfor %}
                    </div>
                    
                    {% if current_category or query %}
                        <button class="btn btn-outline-secondary w-100" id="clearFiltersBtn">
                            <i class="bi bi-x-circle"></i> Limpiar Filtros
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Lista de Productos -->
        <div class="col-lg-9">
            <!-- Controles de Vista -->
            <div class="view-controls">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <h4 class="mb-0" id="productsTitle">
                            {% if current_category %}
                                {% for category in categories %}
                                    {% if category.slug == current_category %}
                                        {{ category.name }}
                                    {% endif %}
                                {% endfor %}
                            {% elif query %}
                                Resultados para "{{ query }}"
                            {% else %}
                                Todos los Productos
                            {% endif %}
                        </h4>
                        <p class="results-info mb-0">
                            Mostrando <strong id="startIndex">{{ products.start_index }}</strong> - 
                            <strong id="endIndex">{{ products.end_index }}</strong> de 
                            <strong id="totalProducts">{{ paginator.count }}</strong> productos
                        </p>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="row g-2">
                            <!-- Ordenar por -->
                            <div class="col-md-6">
                                <select class="form-select form-select-sm" id="sortSelect">
                                    <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Más Recientes</option>
                                    <option value="popular" {% if sort_by == 'popular' %}selected{% endif %}>Más Populares</option>
                                    <option value="price_asc" {% if sort_by == 'price_asc' %}selected{% endif %}>Precio: Menor a Mayor</option>
                                    <option value="price_desc" {% if sort_by == 'price_desc' %}selected{% endif %}>Precio: Mayor a Menor</option>
                                    <option value="name_asc" {% if sort_by == 'name_asc' %}selected{% endif %}>Nombre: A-Z</option>
                                    <option value="name_desc" {% if sort_by == 'name_desc' %}selected{% endif %}>Nombre: Z-A</option>
                                </select>
                            </div>
                            
                            <!-- Productos por página -->
                            <div class="col-md-6">
                                <select class="form-select form-select-sm" id="perPageSelect">
                                    <option value="12" {% if items_per_page == 12 %}selected{% endif %}>12 por página</option>
                                    <option value="24" {% if items_per_page == 24 %}selected{% endif %}>24 por página</option>
                                    <option value="36" {% if items_per_page == 36 %}selected{% endif %}>36 por página</option>
                                    <option value="48" {% if items_per_page == 48 %}selected{% endif %}>48 por página</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Grid de Productos -->
            <div id="productsContainer" class="position-relative">
                <div class="row g-4" id="productsGrid">
                    {% include 'shop/partials/product_grid.html' %}
                </div>
                
                <!-- Loading Overlay -->
                <div class="loading-overlay d-none">
                    <div class="spinner-border spinner-border-custom text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
            
            <!-- Paginación -->
            {% if paginator.num_pages > 1 %}
            <div class="pagination-wrapper mt-5" id="paginationWrapper">
                <nav aria-label="Navegación de productos">
                    <ul class="pagination justify-content-center mb-0" id="paginationNav">
                        <!-- Primera página -->
                        <li class="page-item {% if not products.has_previous %}disabled{% endif %}">
                            <a class="page-link page-nav" 
                               href="#" 
                               data-page="1"
                               aria-label="Primera">
                                <i class="bi bi-chevron-double-left"></i>
                            </a>
                        </li>
                        
                        <!-- Anterior -->
                        <li class="page-item {% if not products.has_previous %}disabled{% endif %}">
                            <a class="page-link page-nav" 
                               href="#" 
                               data-page="{% if products.has_previous %}{{ products.previous_page_number }}{% else %}1{% endif %}"
                               aria-label="Anterior">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                        
                        <!-- Números de página -->
                        {% for num in paginator.page_range %}
                            {% if num == products.number %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > products.number|add:'-3' and num < products.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link page-nav" 
                                       href="#" 
                                       data-page="{{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        <!-- Siguiente -->
                        <li class="page-item {% if not products.has_next %}disabled{% endif %}">
                            <a class="page-link page-nav" 
                               href="#" 
                               data-page="{% if products.has_next %}{{ products.next_page_number }}{% else %}{{ paginator.num_pages }}{% endif %}"
                               aria-label="Siguiente">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        
                        <!-- Última página -->
                        <li class="page-item {% if not products.has_next %}disabled{% endif %}">
                            <a class="page-link page-nav" 
                               href="#" 
                               data-page="{{ paginator.num_pages }}"
                               aria-label="Última">
                                <i class="bi bi-chevron-double-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
                
                <!-- Ir a página específica -->
                <div class="text-center mt-3">
                    <div class="d-inline-flex align-items-center gap-2">
                        <span class="text-muted small">Ir a página:</span>
                        <input type="number" 
                               id="gotoPageInput" 
                               class="form-control form-control-sm" 
                               style="width: 70px;"
                               min="1" 
                               max="{{ paginator.num_pages }}"
                               placeholder="{{ products.number }}">
                        <button class="btn btn-sm btn-primary" id="gotoPageBtn">
                            <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const $productsContainer = $('#productsContainer');
    const $productsGrid = $('#productsGrid');
    const $paginationNav = $('#paginationNav');
    const $paginationWrapper = $('#paginationWrapper');
    const $loadingOverlay = $('.loading-overlay');
    
    // Función para cargar productos con AJAX
    function loadProducts(params = {}) {
        // Mostrar loading
        $productsContainer.addClass('products-loading');
        $loadingOverlay.removeClass('d-none');
        
        // Scroll suave a la sección de productos
        $('html, body').animate({
            scrollTop: $('#products-section').offset().top - 100
        }, 400);
        
        // Construir URL con parámetros
        const urlParams = new URLSearchParams(window.location.search);
        Object.keys(params).forEach(key => {
            if (params[key]) {
                urlParams.set(key, params[key]);
            } else {
                urlParams.delete(key);
            }
        });
        
        const url = '{% url "shop:product_list" %}?' + urlParams.toString();
        
        // Realizar petición AJAX
        $.ajax({
            url: url,
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.success) {
                    // Actualizar productos
                    $productsGrid.html(response.html);
                    
                    // Actualizar información de resultados
                    $('#startIndex').text(response.start_index);
                    $('#endIndex').text(response.end_index);
                    $('#totalProducts').text(response.total_products);
                    
                    // Actualizar paginación
                    updatePagination(response);
                    
                    // Re-inicializar botones de agregar al carrito
                    initAddToCartButtons();
                    
                    // Actualizar URL sin recargar página
                    window.history.pushState({}, '', url);
                    
                    // Ajustar sidebar después de actualizar contenido
                    setTimeout(function() {
                        adjustFiltersSidebar();
                    }, 100);
                }
            },
            error: function() {
                alert('Error al cargar productos');
            },
            complete: function() {
                // Ocultar loading
                $productsContainer.removeClass('products-loading');
                $loadingOverlay.addClass('d-none');
            }
        });
    }
    
    // Actualizar paginación
    function updatePagination(data) {
        if (data.total_pages <= 1) {
            $paginationWrapper.hide();
            return;
        }
        
        $paginationWrapper.show();
        
        let paginationHTML = '';
        
        // Primera página
        paginationHTML += `
            <li class="page-item ${!data.has_previous ? 'disabled' : ''}">
                <a class="page-link page-nav" href="#" data-page="1" aria-label="Primera">
                    <i class="bi bi-chevron-double-left"></i>
                </a>
            </li>
        `;
        
        // Anterior
        paginationHTML += `
            <li class="page-item ${!data.has_previous ? 'disabled' : ''}">
                <a class="page-link page-nav" href="#" data-page="${data.current_page - 1}" aria-label="Anterior">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
        `;
        
        // Números de página (mostrar 5 páginas alrededor de la actual)
        const startPage = Math.max(1, data.current_page - 2);
        const endPage = Math.min(data.total_pages, data.current_page + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            if (i === data.current_page) {
                paginationHTML += `
                    <li class="page-item active">
                        <span class="page-link">${i}</span>
                    </li>
                `;
            } else {
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link page-nav" href="#" data-page="${i}">${i}</a>
                    </li>
                `;
            }
        }
        
        // Siguiente
        paginationHTML += `
            <li class="page-item ${!data.has_next ? 'disabled' : ''}">
                <a class="page-link page-nav" href="#" data-page="${data.current_page + 1}" aria-label="Siguiente">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
        `;
        
        // Última página
        paginationHTML += `
            <li class="page-item ${!data.has_next ? 'disabled' : ''}">
                <a class="page-link page-nav" href="#" data-page="${data.total_pages}" aria-label="Última">
                    <i class="bi bi-chevron-double-right"></i>
                </a>
            </li>
        `;
        
        $paginationNav.html(paginationHTML);
        
        // Actualizar input de ir a página
        $('#gotoPageInput').attr('max', data.total_pages).attr('placeholder', data.current_page);
    }
    
    // Event listeners para paginación
    $(document).on('click', '.page-nav', function(e) {
        e.preventDefault();
        if ($(this).parent().hasClass('disabled')) return;
        
        const page = $(this).data('page');
        loadProducts({ page: page });
    });
    
    // Ir a página específica
    $('#gotoPageBtn').on('click', function() {
        const page = $('#gotoPageInput').val();
        if (page) {
            loadProducts({ page: page });
        }
    });
    
    $('#gotoPageInput').on('keypress', function(e) {
        if (e.which === 13) {
            $('#gotoPageBtn').click();
        }
    });
    
    // Ordenamiento
    $('#sortSelect').on('change', function() {
        loadProducts({ 
            sort: $(this).val(),
            page: 1  // Volver a la primera página al cambiar orden
        });
    });
    
    // Productos por página
    $('#perPageSelect').on('change', function() {
        loadProducts({ 
            per_page: $(this).val(),
            page: 1  // Volver a la primera página al cambiar cantidad
        });
    });
    
    // Filtro por categoría (con AJAX)
    $('.category-filter').on('click', function(e) {
        e.preventDefault();
        const category = $(this).data('category');
        loadProducts({ 
            category: category,
            page: 1
        });
    });
    
    // Limpiar filtros
    $('#clearFiltersBtn').on('click', function() {
        window.location.href = '{% url "shop:product_list" %}';
    });
    
    // Búsqueda en tiempo real (con debounce)
    let searchTimeout;
    $('#searchInput').on('input', function() {
        clearTimeout(searchTimeout);
        const query = $(this).val().trim();
        
        searchTimeout = setTimeout(function() {
            loadProducts({ 
                q: query,
                page: 1
            });
        }, 500);  // Esperar 500ms después de dejar de escribir
    });
    
    // Inicializar botones de agregar al carrito
    function initAddToCartButtons() {
        $('.quick-add-btn').off('click').on('click', function() {
            const productId = $(this).data('product-id');
            const button = $(this);
            
            $.ajax({
                url: "{% url 'shop:add_to_cart' 0 %}".replace('0', productId),
                method: 'POST',
                data: {
                    'quantity': 1,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        $('.cart-badge').text(response.cart_count).show();
                        
                        if (window.animateAddToCart) {
                            window.animateAddToCart(button);
                        }
                        
                        if (window.showCartNotification) {
                            window.showCartNotification('Se ha añadido el producto al carrito');
                        }
                        
                        button.html('<i class="bi bi-check-circle"></i>');
                        button.removeClass('btn-primary').addClass('btn-success');
                        
                        setTimeout(function() {
                            button.html('<i class="bi bi-cart-plus"></i>');
                            button.removeClass('btn-success').addClass('btn-primary');
                        }, 1500);
                    } else {
                        alert(response.message);
                    }
                },
                error: function() {
                    alert('Error al agregar el producto al carrito');
                }
            });
        });
    }
    
    // Inicializar al cargar la página
    initAddToCartButtons();
    
    // ============================================
    // Gestión inteligente del sidebar de filtros
    // ============================================
    function adjustFiltersSidebar() {
        const $navbar = $('.navbar');
        const $filtersCard = $('#filtersCard');
        const $filtersSidebar = $('.filters-sidebar');
        
        if ($filtersCard.length === 0 || $navbar.length === 0) return;
        
        // Asegurar que el contenedor tenga position relative
        if ($filtersSidebar.css('position') !== 'relative') {
            $filtersSidebar.css('position', 'relative');
        }
        
        // Calcular altura del navbar dinámicamente
        const navbarHeight = $navbar.outerHeight(true);
        const scrollTop = $(window).scrollTop();
        const windowHeight = $(window).height();
        
        // Obtener posición inicial del sidebar (sin scroll)
        const sidebarInitialTop = $filtersSidebar.offset().top;
        const sidebarHeight = $filtersCard.outerHeight(true);
        
        // Calcular posición del footer (si existe)
        const $footer = $('.footer');
        let footerTop = document.body.scrollHeight;
        if ($footer.length > 0) {
            footerTop = $footer.offset().top;
        }
        
        // Calcular cuánto espacio hay desde el inicio del sidebar hasta el footer
        const availableHeight = footerTop - sidebarInitialTop;
        
        // Calcular la posición actual del viewport relativa al sidebar
        const viewportBottom = scrollTop + windowHeight;
        const sidebarBottomPosition = sidebarInitialTop + availableHeight;
        
        // Si el viewport está cerca del footer o el sidebar se saldría del contenedor
        if (viewportBottom >= sidebarBottomPosition - 50) {
            // Cambiar a posición absoluta, anclado al final del contenedor
            const remainingSpace = footerTop - sidebarInitialTop - 20; // 20px de margen
            $filtersCard.css({
                'position': 'absolute',
                'top': 'auto',
                'bottom': '0',
                'max-height': Math.min(remainingSpace, windowHeight - navbarHeight - 30) + 'px'
            });
        } else {
            // Mantener sticky con el top calculado dinámicamente
            const topOffset = navbarHeight + 10; // 10px de margen adicional
            $filtersCard.css({
                'position': 'sticky',
                'top': topOffset + 'px',
                'bottom': 'auto',
                'max-height': 'calc(100vh - ' + (topOffset + 20) + 'px)'
            });
        }
    }
    
    // Ajustar sidebar al cargar y al hacer scroll (con debounce para mejor performance)
    let sidebarAdjustTimeout;
    function debouncedAdjustSidebar() {
        clearTimeout(sidebarAdjustTimeout);
        sidebarAdjustTimeout = setTimeout(function() {
            adjustFiltersSidebar();
        }, 10);
    }
    
    $(window).on('scroll resize', debouncedAdjustSidebar);
    
    // Ajustar inicialmente
    setTimeout(function() {
        adjustFiltersSidebar();
    }, 100);
});
</script>
{% endblock %}